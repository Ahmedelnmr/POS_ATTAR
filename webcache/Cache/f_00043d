<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
    <link rel="stylesheet" href="public/css/main.css?v=1771193925">

</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<div class="app-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <h2>ğŸ’° POS System</h2>
            <span>Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </div>
        <nav class="sidebar-nav">
            <a href="?page=dashboard" class="nav-item ">
                <span class="icon">ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </a>
            <a href="?page=pos" class="nav-item ">
                <span class="icon">ğŸ›’</span> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
            </a>
            <a href="?page=products" class="nav-item ">
                <span class="icon">ğŸ“¦</span> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            </a>
            <a href="?page=suppliers" class="nav-item ">
                <span class="icon">ğŸ­</span> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
            </a>
            <a href="?page=purchases" class="nav-item ">
                <span class="icon">ğŸ§¾</span> Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            </a>
            <a href="?page=inventory" class="nav-item ">
                <span class="icon">ğŸ“‹</span> Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            </a>
            <a href="?page=sales" class="nav-item ">
                <span class="icon">ğŸ’µ</span> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            </a>
            <a href="?page=reports" class="nav-item active">
                <span class="icon">ğŸ“ˆ</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            </a>
        </nav>
        <div class="sidebar-footer">
            Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ v1.0 &copy; 2026        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
<!-- Reports Dashboard -->
<div class="page-header">
    <div>
        <h1>ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1>
        <p class="subtitle">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</p>
    </div>
</div>

<!-- Report Type Tabs -->
<div class="card" style="padding:12px 16px;">
    <div class="btn-group">
        <button class="btn btn-primary" onclick="loadReport('daily')">ğŸ“… ÙŠÙˆÙ…ÙŠ</button>
        <button class="btn btn-outline" onclick="loadReport('weekly')">ğŸ“† Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
        <button class="btn btn-outline" onclick="loadReport('monthly')">ğŸ—“ï¸ Ø´Ù‡Ø±ÙŠ</button>
        <button class="btn btn-outline" onclick="loadReport('topProducts')">ğŸ† Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</button>
        <button class="btn btn-outline" onclick="loadReport('leastProducts')">ğŸ“‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¨ÙŠØ¹Ø§Ù‹</button>
        <button class="btn btn-outline" onclick="loadReport('lowStock')">âš ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶</button>
        <button class="btn btn-outline" onclick="loadReport('suppliers')">ğŸ­ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯</button>
    </div>
</div>

<!-- Date Range Picker (for range reports) -->
<div class="card" id="dateRangeCard" style="padding:14px 20px;display:none;">
    <div class="d-flex align-center gap-2">
        <label class="text-muted">Ù…Ù†:</label>
        <input type="date" id="reportDateFrom" class="form-control" style="width:160px;">
        <label class="text-muted">Ø¥Ù„Ù‰:</label>
        <input type="date" id="reportDateTo" class="form-control" style="width:160px;">
        <button class="btn btn-primary btn-sm" onclick="loadRangeReport()">Ø¹Ø±Ø¶</button>
    </div>
</div>

<!-- Report Content Area -->
<div class="card" id="reportContent">
    <div style="padding:40px; text-align:center;">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>
    </div>
</div>

<script>
// API Request Helper (inlined)
// API Request Helper (inlined)
async function apiRequest(url, options = {}) {
    try {
        debugLog('Fetching: ' + url);
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        };

        if (options.body && typeof options.body === 'object') {
            options.body = JSON.stringify(options.body);
        }

        const response = await fetch(url, { ...defaultOptions, ...options });
        debugLog('Response status: ' + response.status);
        
        if (!response.ok) {
            const txt = await response.text();
            debugLog('Response Error Body: ' + txt.substring(0, 100)); // Log first 100 chars
            throw new Error('HTTP Error ' + response.status);
        }

        const json = await response.json();
        debugLog('JSON parsed successfully. Success=' + json.success);
        return json;
    } catch (error) {
        debugLog('API Error: ' + error.message);
        return { success: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message };
    }
}

let currentReport = '';

async function loadReport(type) {
    currentReport = type;
    const content = document.getElementById('reportContent');
    const dateCard = document.getElementById('dateRangeCard');
    content.innerHTML = '<div class="spinner"></div>';

    // Update active button (only if event exists)
    document.querySelectorAll('.btn-group .btn').forEach(b => {
        b.className = b.className.replace('btn-primary', 'btn-outline');
    });
    
    // Find and activate the button for this report type
    const buttons = document.querySelectorAll('.btn-group .btn');
    const buttonTexts = ['ÙŠÙˆÙ…ÙŠ', 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ', 'Ø´Ù‡Ø±ÙŠ', 'Ø§Ù„Ø£ÙƒØ«Ø±', 'Ø§Ù„Ø£Ù‚Ù„', 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª'];
    const reportTypes = ['daily', 'weekly', 'monthly', 'topProducts', 'leastProducts', 'lowStock', 'suppliers'];
    const index = reportTypes.indexOf(type);
    if (index >= 0 && buttons[index]) {
        buttons[index].className = buttons[index].className.replace('btn-outline', 'btn-primary');
    }

    try {
        let url = '';
        switch (type) {
            case 'daily':
                dateCard.style.display = 'none';
                url = '?page=reports&action=daily&date=' + (new Date().toISOString().split('T')[0]);
                const dailyRes = await apiRequest(url);
                if (dailyRes.success) {
                    renderDailyReport(dailyRes.data);
                } else {
                    throw new Error(dailyRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'weekly':
                dateCard.style.display = 'none';
                const weekFrom = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                const weekTo = new Date().toISOString().split('T')[0];
                url = `?page=reports&action=range&from=${weekFrom}&to=${weekTo}`;
                const weeklyRes = await apiRequest(url);
                if (weeklyRes.success) {
                    renderRangeReport(weeklyRes.data, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ');
                } else {
                    throw new Error(weeklyRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'monthly':
                dateCard.style.display = 'none';
                const monthFrom = new Date().toISOString().slice(0, 8) + '01';
                const monthTo = new Date().toISOString().split('T')[0];
                url = `?page=reports&action=range&from=${monthFrom}&to=${monthTo}`;
                const monthlyRes = await apiRequest(url);
                if (monthlyRes.success) {
                    renderRangeReport(monthlyRes.data, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ');
                } else {
                    throw new Error(monthlyRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'topProducts':
                dateCard.style.display = 'none';
                const topRes = await apiRequest('?page=reports&action=topProducts');
                if (topRes.success) {
                    renderProductReport(topRes.data, 'ğŸ† Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹');
                } else {
                    throw new Error(topRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'leastProducts':
                dateCard.style.display = 'none';
                const leastRes = await apiRequest('?page=reports&action=leastProducts');
                if (leastRes.success) {
                    renderLeastReport(leastRes.data);
                } else {
                    throw new Error(leastRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'lowStock':
                dateCard.style.display = 'none';
                const lowRes = await apiRequest('?page=reports&action=lowStock');
                if (lowRes.success) {
                    renderLowStockReport(lowRes.data);
                } else {
                    throw new Error(lowRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;

            case 'suppliers':
                dateCard.style.display = 'none';
                const supRes = await apiRequest('?page=reports&action=supplierPurchases');
                if (supRes.success) {
                    renderSupplierReport(supRes.data);
                } else {
                    throw new Error(supRes.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                }
                break;
        }
    } catch (error) {
        console.error('Report Error:', error);
        content.innerHTML = `
            <div class="empty-state">
                <div class="icon" style="font-size:48px;">âŒ</div>
                <p style="color:#ef4444; font-weight:bold;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                <p class="text-muted">${error.message || 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}</p>
            </div>
        `;
    }
}

function renderDailyReport(data) {
    const content = document.getElementById('reportContent');
    const s = data.summary;
    content.innerHTML = `
        <div class="card-header"><h3>ğŸ“… ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${data.date}</h3></div>
        <div class="stats-grid" style="margin-bottom:16px;">
            <div class="stat-card"><div class="stat-icon green">ğŸ’µ</div><div class="stat-info"><h4>${parseFloat(s.total).toFixed(2)}</h4><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p></div></div>
            <div class="stat-card"><div class="stat-icon blue">ğŸ§¾</div><div class="stat-info"><h4>${s.count}</h4><p>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p></div></div>
            <div class="stat-card"><div class="stat-icon orange">ğŸ·ï¸</div><div class="stat-info"><h4>${parseFloat(s.discount || 0).toFixed(2)}</h4><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</p></div></div>
        </div>
        ${data.sales.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>#</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th><th>Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                <tbody>
                    ${data.sales.map(s => `
                        <tr>
                            <td>#${s.sale_number || s.id}</td>
                            <td class="fs-sm">${s.datetime}</td>
                            <td>${s.item_count}</td>
                            <td><span class="badge badge-success">${s.payment_method === 'cash' ? 'Ù†Ù‚Ø¯ÙŠ' : s.payment_method}</span></td>
                            <td class="fw-bold text-accent">${parseFloat(s.total).toFixed(2)}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p></div>'}
    `;
}

function renderRangeReport(data, title) {
    const content = document.getElementById('reportContent');
    const t = data.totals;
    content.innerHTML = `
        <div class="card-header"><h3>${title}</h3></div>
        <div class="stats-grid" style="margin-bottom:16px;">
            <div class="stat-card"><div class="stat-icon green">ğŸ’µ</div><div class="stat-info"><h4>${parseFloat(t.total).toFixed(2)}</h4><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p></div></div>
            <div class="stat-card"><div class="stat-icon blue">ğŸ§¾</div><div class="stat-info"><h4>${t.count}</h4><p>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p></div></div>
        </div>
        ${data.daily.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                <tbody>
                    ${data.daily.map(d => `
                        <tr>
                            <td class="fw-bold">${d.sale_date}</td>
                            <td>${d.count}</td>
                            <td class="fw-bold text-accent">${parseFloat(d.total).toFixed(2)}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>'}
    `;
}

function renderProductReport(data, title) {
    const content = document.getElementById('reportContent');
    content.innerHTML = `
        <div class="card-header"><h3>${title}</h3></div>
        ${data.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>#</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th></tr></thead>
                <tbody>
                    ${data.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td class="fw-bold">${p.product_name}</td>
                            <td>${parseFloat(p.total_qty).toFixed(2)}</td>
                            <td>${p.sale_count}</td>
                            <td class="fw-bold text-accent">${parseFloat(p.total_revenue).toFixed(2)}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>'}
    `;
}

function renderLeastReport(data) {
    const content = document.getElementById('reportContent');
    content.innerHTML = `
        <div class="card-header"><h3>ğŸ“‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3></div>
        ${data.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>#</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th></tr></thead>
                <tbody>
                    ${data.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td class="fw-bold">${p.name}</td>
                            <td>${parseFloat(p.stock_quantity).toFixed(2)}</td>
                            <td class="text-warning">${parseFloat(p.total_sold).toFixed(2)}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>'}
    `;
}

function renderLowStockReport(data) {
    const content = document.getElementById('reportContent');
    content.innerHTML = `
        <div class="card-header"><h3>âš ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ (${data.length})</h3></div>
        ${data.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th><th>Ø§Ù„Ù‚Ø³Ù…</th></tr></thead>
                <tbody>
                    ${data.map(p => `
                        <tr>
                            <td class="fw-bold">${p.name}</td>
                            <td><span class="badge badge-info">${p.type}</span></td>
                            <td><span class="badge badge-danger">${p.stock_quantity}</span></td>
                            <td>${p.min_stock}</td>
                            <td class="text-muted">${p.category || 'â€”'}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø¢Ù…Ù†</p></div>'}
    `;
}

function renderSupplierReport(data) {
    const content = document.getElementById('reportContent');
    content.innerHTML = `
        <div class="card-header"><h3>ğŸ­ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯</h3></div>
        ${data.length ? `
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th></tr></thead>
                <tbody>
                    ${data.map(s => `
                        <tr>
                            <td class="fw-bold">${s.name}</td>
                            <td>${s.invoice_count}</td>
                            <td class="fw-bold text-accent">${parseFloat(s.total).toFixed(2)}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>` : '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>'}
    `;
}


// Load daily report by default

// DEBUGGING UTILITY
function debugLog(msg) {
    const box = document.getElementById('debugBox');
    if (box) {
        box.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        console.log(msg); // Also log to console
    }
}

// Add debug box to page
document.addEventListener('DOMContentLoaded', function() {
    if(!document.getElementById('debugBox')) {
        const div = document.createElement('div');
        div.id = 'debugBox';
        div.style.cssText = 'position:fixed; bottom:0; left:0; width:100%; height:150px; background:#000; color:#0f0; overflow:auto; padding:10px; font-family:monospace; z-index:9999; opacity:0.9; direction:ltr; text-align:left;';
        document.body.appendChild(div);
        debugLog('Debug console initialized');
    }
});

// Load daily report by default - executed immediately at end of body
try {
    debugLog('Script starting...');
    // Small delay to ensure DOM is partially ready
    setTimeout(() => {
        debugLog('Calling loadReport(daily)...');
        loadReport('daily');
    }, 500);
} catch(e) {
    alert('Global Script Error: ' + e.message);
    document.getElementById('reportContent').innerHTML = '<div style="color:red">Error: ' + e.message + '</div>';
}
</script>
    </main>
</div>
<!-- App JS -->
<script src="public/js/app_core.js?v=1771193925"></script>

</body>
</html>
