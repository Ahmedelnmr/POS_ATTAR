/**
 * POS.js - Point of Sale Frontend Logic
 * Version: Fixed & Consolidated
 */

// ==========================================
// STATE & INITIALIZATION
// ==========================================
let cart = [];
let discount = 0;
let selectedWeightProduct = null;
let selectedCartIndex = -1;

// Load initial data
document.addEventListener('DOMContentLoaded', function () {
    try {
        const barcodeInput = document.getElementById('barcodeInput');
        if (barcodeInput) barcodeInput.focus();

        // Barcode Listener
        if (barcodeInput) {
            barcodeInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const code = this.value.trim();
                    if (code) {
                        addByCode(code);
                        this.value = '';
                        hideSearchResults();
                    }
                }
            });

            // Live search for barcode input
            barcodeInput.addEventListener('input', debounce(function () {
                const q = this.value.trim();
                if (q.length >= 2) {
                    liveSearchBarcode(q);
                } else {
                    hideSearchResults();
                }
            }, 250));
        }

        // Global Click Listener
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.pos-input-section')) {
                hideSearchResults('searchResults');
                hideSearchResults('productSearchResults');
            }
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', handleShortcuts);

    } catch (err) {
        console.error('POS Init Error:', err);
    }
});

function handleShortcuts(e) {
    const barcodeInput = document.getElementById('barcodeInput');

    // F2: Focus barcode
    if (e.key === 'F2') {
        e.preventDefault();
        if (barcodeInput) {
            barcodeInput.focus();
            barcodeInput.select();
        }
    }

    // F3: Show Details
    if (e.key === 'F3') {
        e.preventDefault();
        if (typeof showSelectedProductDetails === 'function') showSelectedProductDetails();
    }

    // F5: Checkout
    if (e.key === 'F5') {
        e.preventDefault();
        processCheckout();
    }

    // F8: Switch Unit
    if (e.key === 'F8') {
        e.preventDefault();
        if (typeof toggleSelectedUnitType === 'function') toggleSelectedUnitType();
    }

    // Escape: Close
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        if (barcodeInput) barcodeInput.focus();
        hideSearchResults('searchResults');
        hideSearchResults('productSearchResults');
    }

    // Arrows: Navigation
    if (e.key === 'ArrowDown' && cart.length > 0) {
        e.preventDefault();
        selectedCartIndex = Math.min(selectedCartIndex + 1, cart.length - 1);
        renderCart();
    }
    if (e.key === 'ArrowUp' && cart.length > 0) {
        e.preventDefault();
        selectedCartIndex = Math.max(selectedCartIndex - 1, 0);
        renderCart();
    }
}

// ==========================================
// SEARCH LOGIC
// ==========================================

// Add product by exact code
async function addByCode(code) {
    const res = await apiRequest('?page=pos&action=findProduct&q=' + encodeURIComponent(code));
    if (res.success && res.data) {
        addToCart(res.data, 1, 'unit');
    } else {
        showToast(res.message || 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ: ' + code, 'error');
    }
}

// Live search for barcode field
async function liveSearchBarcode(query) {
    const res = await apiRequest('?page=pos&action=search&q=' + encodeURIComponent(query));
    if (res.success && res.data && res.data.length > 0) {
        showSearchResults(res.data, 'searchResults');
    } else {
        hideSearchResults('searchResults');
    }
}

// Main Product Search (Debounced)
const searchProducts = debounce(async function (query) {
    const container = document.getElementById('productSearchResults');
    if (!query || query.length < 2) {
        hideSearchResults('productSearchResults');
        return;
    }

    // Show loading state
    if (container) {
        container.innerHTML = '<div style="padding:10px;text-align:center;color:#666">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...</div>';
        container.classList.add('active');
    }

    try {
        const res = await apiRequest('?page=pos&action=search&q=' + encodeURIComponent(query));
        if (res.success && res.data && res.data.length > 0) {
            showSearchResults(res.data, 'productSearchResults');
        } else {
            if (container) {
                container.innerHTML = '<div style="padding:10px;text-align:center;color:#666">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</div>';
                // Keep visible briefly so user sees "No results"
                // setTimeout(() => hideSearchResults('productSearchResults'), 1500);
            }
        }
    } catch (e) {
        console.error(e);
        hideSearchResults('productSearchResults');
    }
}, 300);

// Alias for compatibility if index.php calls it
const searchProductsNew = searchProducts;

function showSearchResults(products, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = products.map(p => `
        <div class="pos-search-item" onclick="selectSearchProduct(${p.id})">
            <div>
                <div class="name">${escapeHtml(p.name)}</div>
                <div class="meta">${p.barcode || ''} ${p.plu_code ? '| PLU: ' + p.plu_code : ''}</div>
            </div>
            <div class="price">${parseFloat(p.sale_price_unit).toFixed(2)}</div>
        </div>
    `).join('');
    container.classList.add('active');
}

function hideSearchResults(containerId = 'searchResults') {
    const container = document.getElementById(containerId);
    if (container) container.classList.remove('active');
}

async function selectSearchProduct(productId) {
    try {
        const res = await apiRequest('?page=pos&action=findProduct&q=' + productId);
        if (res.success && res.data) {
            addToCart(res.data, 1, res.data.type === 'weight' ? 'weight' : 'unit');

            // Clear inputs
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) barcodeInput.value = '';

            const productSearch = document.getElementById('productSearch');
            if (productSearch) productSearch.value = '';

            // Hide all results
            hideSearchResults('searchResults');
            hideSearchResults('productSearchResults');
        }
    } catch (e) {
        console.error(e);
        showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨', 'error');
    }
}
// Compatibility alias
const selectSearchProductv2 = selectSearchProduct;


// ==========================================
// CART OPERATIONS
// ==========================================
function addToCart(product, quantity = 1, saleMode = 'unit', unitType = 'ŸÇÿ∑ÿπÿ©') {
    let price;
    let actualQty = quantity;

    // Determine price based on mode
    switch (saleMode) {
        case 'pack':
            price = parseFloat(product.pack_sale_price) || parseFloat(product.sale_price_unit);
            if (product.pack_unit_quantity) {
                actualQty = quantity * parseFloat(product.pack_unit_quantity);
            }
            break;
        case 'weight':
            price = parseFloat(product.sale_price_unit);
            actualQty = quantity;
            break;
        default: // unit
            price = parseFloat(product.sale_price_unit);
            actualQty = quantity;
    }

    // Check existing item
    const existingIndex = cart.findIndex(item =>
        item.product_id === product.id && item.sale_mode === saleMode && item.unit_type === unitType
    );

    if (existingIndex >= 0 && saleMode !== 'custom') {
        cart[existingIndex].quantity += quantity;
        cart[existingIndex].actual_quantity = (cart[existingIndex].actual_quantity || cart[existingIndex].quantity) + actualQty;
        cart[existingIndex].subtotal = cart[existingIndex].quantity * cart[existingIndex].price;
    } else {
        cart.push({
            product_id: product.id,
            product_name: product.name,
            quantity: quantity,
            actual_quantity: actualQty,
            unit_type: unitType,
            price: price,
            sale_mode: saleMode,
            subtotal: quantity * price,
            // Store details for toggling
            product_unit_price: product.sale_price_unit,
            product_pack_price: product.pack_sale_price,
            product_pack_type: product.pack_type,
            product_pack_quantity: product.pack_unit_quantity
        });
    }

    renderCart();
    showToast('‚úÖ ' + product.name);

    // Play sound? (Optional)
}

function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
}

function updateCartQty(index, newQty) {
    if (newQty <= 0) {
        removeFromCart(index);
        return;
    }
    cart[index].quantity = parseFloat(newQty);

    // Update actual qty for pack items if needed
    if (cart[index].sale_mode === 'pack' && cart[index].product_pack_quantity) {
        cart[index].actual_quantity = cart[index].quantity * parseFloat(cart[index].product_pack_quantity);
    } else {
        cart[index].actual_quantity = cart[index].quantity;
    }

    cart[index].subtotal = cart[index].quantity * cart[index].price;
    renderCart();
}

function changeQty(index, delta) {
    if (!cart[index]) return;
    const newQty = cart[index].quantity + delta;
    updateCartQty(index, newQty);
}

function clearCart() {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑÿ≥ŸÑÿ©ÿü')) return;
    cart = [];
    discount = 0;
    renderCart();
}

function changeUnitType(index, newUnitType) {
    if (!cart[index]) return;

    var item = cart[index];
    item.unit_type = newUnitType;

    if (newUnitType === 'ŸÇÿ∑ÿπÿ©') {
        item.sale_mode = 'unit';
        item.price = parseFloat(item.product_unit_price) || item.price;
        item.actual_quantity = item.quantity;
    } else {
        item.sale_mode = 'pack';
        item.price = parseFloat(item.product_pack_price) || item.price;
        if (item.product_pack_quantity) {
            item.actual_quantity = item.quantity * parseFloat(item.product_pack_quantity);
        }
    }

    item.subtotal = item.quantity * item.price;
    renderCart();
}

// ==========================================
// RENDER UI
// ==========================================
function renderCart() {
    const tbody = document.getElementById('cartBody');
    if (!tbody) return;

    if (cart.length === 0) {
        tbody.innerHTML = `
            <tr id="emptyCart">
                <td colspan="7">
                    <div class="empty-cart-state">
                        <div class="icon">üõí</div>
                        <p>ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© - ÿßÿ®ÿØÿ£ ÿ®ŸÖÿ≥ÿ≠ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ£Ÿà ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨</p>
                    </div>
                </td>
            </tr>`;
        selectedCartIndex = -1;
        updateTotals();
        return;
    }

    tbody.innerHTML = cart.map((item, i) => {
        let unitOptions = '<option value="ŸÇÿ∑ÿπÿ©">ŸÇÿ∑ÿπÿ©</option>';
        if (item.product_pack_type && item.product_pack_quantity) {
            unitOptions += `<option value="${escapeHtml(item.product_pack_type)}">${escapeHtml(item.product_pack_type)}</option>`;
        }

        // Select correct option
        const selectedUnit = item.unit_type || 'ŸÇÿ∑ÿπÿ©';
        unitOptions = unitOptions.replace(`value="${selectedUnit}"`, `value="${selectedUnit}" selected`);

        const isSelected = i === selectedCartIndex ? 'selected' : '';
        const modeLabel = getModeLabel(item.sale_mode);
        const badge = item.sale_mode !== 'unit' ? `<span class="badge badge-info">${modeLabel}</span>` : '';

        return `
        <tr class="${isSelected}" onclick="selectCartRow(${i})">
            <td class="text-muted">${i + 1}</td>
            <td>
                <div class="product-name-cell">
                    <div class="name">${escapeHtml(item.product_name)}</div>
                    ${badge}
                </div>
            </td>
            <td>
                <select class="unit-type-select" onchange="changeUnitType(${i}, this.value)" onclick="event.stopPropagation()">
                    ${unitOptions}
                </select>
            </td>
            <td>
                <div class="qty-control">
                    <button class="qty-btn" onclick="event.stopPropagation();changeQty(${i}, -1)">‚àí</button>
                    <input type="number" class="qty-value" value="${item.quantity}" min="0.01" step="${item.sale_mode === 'weight' ? '0.001' : '1'}"
                           onchange="event.stopPropagation();updateCartQty(${i}, parseFloat(this.value))" onclick="event.stopPropagation()">
                    <button class="qty-btn" onclick="event.stopPropagation();changeQty(${i}, 1)">+</button>
                </div>
            </td>
            <td class="text-muted">${item.price.toFixed(2)}</td>
            <td class="fw-bold">${item.subtotal.toFixed(2)}</td>
            <td><button class="remove-btn" onclick="event.stopPropagation();removeFromCart(${i})">‚úï</button></td>
        </tr>
        `;
    }).join('');

    if (selectedCartIndex === -1 && cart.length > 0) selectedCartIndex = 0;
    updateTotals();
}

function selectCartRow(index) {
    selectedCartIndex = index;
    renderCart();
}

function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
    const total = subtotal - discount;

    setText('subtotalDisplay', subtotal.toFixed(2));
    setText('discountDisplay', discount.toFixed(2));
    setText('totalDisplay', total.toFixed(2));

    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.disabled = cart.length === 0;
}

function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

function getModeLabel(mode) {
    const labels = { 'unit': 'Ÿàÿ≠ÿØÿ©', 'pack': 'ÿπÿ®Ÿàÿ©', 'weight': 'Ÿàÿ≤ŸÜ', 'custom': 'ŸäÿØŸàŸä' };
    return labels[mode] || mode;
}

// ==========================================
// MODAL ACTIONS
// ==========================================

// Discount
function openDiscount() {
    const el = document.getElementById('discountValue');
    if (el) el.value = discount || '';
    openModal('discountModal');
    setTimeout(() => { if (el) el.focus(); }, 200);
}

function applyDiscount() {
    const el = document.getElementById('discountValue');
    discount = parseFloat(el ? el.value : 0) || 0;
    updateTotals();
    closeModal('discountModal');
    showToast('ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿµŸÖ: ' + discount.toFixed(2));
}

// Manual Price
function openManualPrice() {
    setVal('manualName', '');
    setVal('manualPriceValue', '');
    setVal('manualQty', '1');
    openModal('manualPriceModal');
    setTimeout(() => document.getElementById('manualName').focus(), 200);
}

function addManualPrice() {
    const name = document.getElementById('manualName').value.trim() || 'ŸÖŸÜÿ™ÿ¨ ŸäÿØŸàŸä';
    const price = parseFloat(document.getElementById('manualPriceValue').value);
    const qty = parseFloat(document.getElementById('manualQty').value) || 1;

    if (!price || price <= 0) {
        showToast('ÿ£ÿØÿÆŸÑ ÿ≥ÿπÿ± ÿµÿ≠Ÿäÿ≠', 'error');
        return;
    }

    cart.push({
        product_id: null,
        product_name: name,
        quantity: qty,
        price: price,
        sale_mode: 'custom',
        unit_type: 'ŸÇÿ∑ÿπÿ©',
        subtotal: qty * price,
        actual_quantity: qty
    });

    renderCart();
    closeModal('manualPriceModal');
}

// Weight
function openWeightInput() {
    setVal('weightProductSearch', '');
    setVal('weightProductId', '');
    setVal('weightValue', '');
    setText('weightProgressBar', ''); // if exists
    document.getElementById('weightProductResults').innerHTML = '';
    selectedWeightProduct = null;
    openModal('weightModal');
    setTimeout(() => document.getElementById('weightProductSearch').focus(), 200);
}

async function searchWeightProducts(query) {
    if (query.length < 1) {
        document.getElementById('weightProductResults').innerHTML = '';
        return;
    }
    const res = await apiRequest('?page=pos&action=search&q=' + encodeURIComponent(query));
    if (res.success && res.data) {
        const container = document.getElementById('weightProductResults');
        container.innerHTML = res.data.map(p => `
            <div class="pos-search-item" style="border:1px solid #eee; margin-bottom:5px; padding:8px; display:flex; justify-content:space-between; cursor:pointer;"
                 onclick="selectWeightProduct(${p.id}, '${escapeHtml(p.name)}', ${p.sale_price_unit})">
                <span class="name">${escapeHtml(p.name)}</span>
                <span class="price">${parseFloat(p.sale_price_unit).toFixed(2)}/ŸÉÿ¨ŸÖ</span>
            </div>
        `).join('');
    }
}

function selectWeightProduct(id, name, price) {
    selectedWeightProduct = { id, name, price };
    setVal('weightProductId', id);
    setVal('weightProductSearch', name);
    document.getElementById('weightProductResults').innerHTML = '';
    document.getElementById('weightValue').focus();
}

function addWeightItem() {
    if (!selectedWeightProduct) {
        showToast('ÿßÿÆÿ™ÿ± ŸÖŸÜÿ™ÿ¨ ÿ£ŸàŸÑÿßŸã', 'error');
        return;
    }
    const weight = parseFloat(document.getElementById('weightValue').value);
    if (!weight || weight <= 0) {
        showToast('ÿ£ÿØÿÆŸÑ ÿßŸÑŸàÿ≤ŸÜ', 'error');
        return;
    }
    addToCart({
        id: selectedWeightProduct.id,
        name: selectedWeightProduct.name,
        sale_price_unit: selectedWeightProduct.price
    }, weight, 'weight', 'ŸÉÿ¨ŸÖ');
    closeModal('weightModal');
}

function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = val;
}

// ==========================================
// CHECKOUT & RECEIPT
// ==========================================
async function processCheckout() {
    if (cart.length === 0) return;

    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) {
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...';
    }

    const payload = {
        items: cart,
        discount: discount,
        payment_method: 'cash',
        notes: ''
    };

    const res = await apiRequest('?page=pos&action=checkout', {
        method: 'POST',
        body: payload
    });

    if (res.success) {
        showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
        if (typeof showReceipt === 'function') showReceipt(res.data.sale);
        cart = [];
        discount = 0;
        renderCart();
    } else {
        showToast(res.message || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ®Ÿäÿπ', 'error');
    }

    if (checkoutBtn) {
        checkoutBtn.disabled = cart.length === 0;
        checkoutBtn.textContent = '‚úÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ (F5)';
    }
}

function showReceipt(sale) {
    const content = document.getElementById('receiptContent');
    if (!content) return;

    content.innerHTML = `
        <div class="receipt" style="text-align:center;">
            <h3>ÿ•ŸäÿµÿßŸÑ ÿ®Ÿäÿπ</h3>
            <div style="font-size:12px;color:#666;margin-bottom:10px;">
                ÿ±ŸÇŸÖ: ${sale.sale_number || sale.id}<br>
                ${sale.datetime}
            </div>
            <table style="width:100%;font-size:12px;border-top:1px dashed #ccc;border-bottom:1px dashed #ccc;margin:10px 0;">
                <thead><tr><th style="text-align:right">ÿµŸÜŸÅ</th><th>ŸÉ</th><th>ÿ≥ÿπÿ±</th><th>ÿ•ÿ¨ŸÖÿßŸÑŸä</th></tr></thead>
                <tbody>
                ${(sale.items || []).map(item => `
                    <tr>
                        <td style="text-align:right">${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>${parseFloat(item.price).toFixed(2)}</td>
                        <td>${parseFloat(item.subtotal).toFixed(2)}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            <div style="font-size:16px;font-weight:bold;margin:10px 0;">
                ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${parseFloat(sale.total).toFixed(2)}
            </div>
        </div>
    `;
    openModal('receiptModal');
}

function printReceipt() {
    const content = document.getElementById('receiptContent').innerHTML;
    const win = window.open('', '_blank', 'width=350,height=600');
    win.document.write(`
        <html dir="rtl"><head><title>Print</title>
        <style>body{font-family:monospace;padding:10px;text-align:right;}</style>
        </head><body>${content}</body></html>
    `);
    win.document.close();
    win.print();
}

// Utility for HTML escaping
function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
